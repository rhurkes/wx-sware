const toRad=t=>t*Math.PI/180,R=3961,get_distance=(t,a)=>{const l=toRad(t.lat),n=toRad(a.lat),o=toRad(a.lat-t.lat),s=toRad(a.lon-t.lon),_=Math.sin(o/2)*Math.sin(o/2)+Math.cos(l)*Math.cos(n)*Math.sin(s/2)*Math.sin(s/2),h=2*Math.atan2(Math.sqrt(_),Math.sqrt(1-_)),i=R*h;return Math.floor(i)},is_point_in_bounds=(t,a)=>t.lat>=a.min_lat&&t.lat<=a.max_lat&&t.lon>=a.min_lon&&t.lon<=a.max_lon,poly_to_bounds=t=>{let a=t[0].lat,l=t[0].lon,n=t[0].lat,o=t[0].lon;return t.forEach(t=>{t.lat<a&&(a=t.lat),t.lon>l&&(l=t.lon),t.lat>n&&(n=t.lat),t.lon<o&&(o=t.lon)}),{min_lat:a,min_lon:l,max_lat:n,max_lon:o}};const api_base="https://sigtor.org/v1/events",poll_delay_ms=6e4,minute_in_us=6e7,hour_in_us=36e8,day_in_us=864e8,chase_mode_distance_miles=120,event_retention_in_us=108e8,ls_config_items_key="sware-config-items",ls_config_key="sware-config",sev_hail_threshold=2,tor_related_hazards=["Tornado","WallCloud","Funnel"],tor_emergency_blurb="The National Weather Service has issued a Tornado Emergency.",new_watch_blurb="The Storm Prediction Center has issued a new $PDS $WATCHTYPE watch for $PLACE.",new_md_blurb="The Storm Prediction Center has issued mesoscale discussion $NUMBER $PROBABILITY.",new_outlook_blurb="The Storm Prediction Center has issued a new Day 1 outlook, $RISK.",sev_hail_blurb="$MAG inch severe hail has been reported $PLACE.",tor_blurb="A tornado has been reported $PLACE by $REPORTER.",tor_warning_blurb="The National Weather Service has issued a $PDS Tornado Warning for: $PLACE";let last_ts=0,geo_location={};const fetchUrl=e=>fetch(e).then(function(e){return e.json()}).then(function(e){const t=e.map(prepareEvent).reverse();t[0]&&(last_ts=t[0].ingest_ts,app.events=t.concat(app.events)),processEvents()}),geo_options={enableHighAccuracy:!0,timeout:5e3,maximumAge:0};function geo_success(e){geo_location={lat:e.coords.latitude,lon:e.coords.longitude}}setInterval(()=>{app.config_items.find(e=>"gpsLocation"===e.id).toggled||navigator.geolocation.getCurrentPosition(console.info,console.warn,geo_options)},6e4),setInterval(()=>{app.clock=get_clock()},1e3);const get_clock=()=>{const e=new Date;return`${pad_zero(e.getUTCHours())}${pad_zero(e.getUTCMinutes())}Z`},prepareEvent=e=>{const t={},o=new Date(e.event_ts/1e3),n=`${pad_zero(o.getUTCHours())}${pad_zero(o.getUTCMinutes())}Z`;if(t.is_important=get_importance(e),t.is_tor_related=is_tor_related(e),t.parsed_dt=n,e.location&&e.location.poly){const o=poly_to_bounds(e.location.poly);t.point=get_center_simple(e.location.poly),t.bounds=o;const n=get_distance({lat:o.min_lat,lon:o.min_lon},{lat:o.max_lat,lon:o.max_lon})/2;t.half_edge_distance=n}return e.derived=t,e},filterEvent=(e,t)=>{if(app.config_items.find(e=>"chaseMode"===e.id).toggled)if(e.location&&e.location.point){if(get_distance(t,e.location.point)>120)return!1}else if(e.derived.point&&e.derived.half_edge_distance){if(get_distance(t,e.derived.point)>120+e.derived.half_edge_distance)return!1}return!app.config_items.find(e=>"hideAfds"===e.id).toggled||"NwsAfd"!==e.event_type},massageEvent=(e,t)=>{const o=1e3*Date.now();if(e.derived.time_ago=get_time_ago(o,e.ingest_ts),t&&e.location&&e.location.point){const o=get_distance(t,e.location.point);e.derived.distance=`${o}mi`}return e},is_tor_related=e=>!!(e.report&&tor_related_hazards.indexOf(e.report.hazard)>-1)||("NwsTor"===e.event_type||("NwsSvs"===e.event_type||!("NwsSel"!==e.event_type||!e.watch||"Tornado"!==e.watch.watch_type))),get_current_location=()=>{if(app.config_items.find(e=>"gpsLocation"===e.id).toggled&&!isNaN(app.config.manualLat)&&!isNaN(app.config.manualLon))return{lat:app.config.manualLat,lon:app.config.manualLon}},buildAlertForEvent=e=>{let t,o=!1;return e.seen?e:(e.seen=!0,e.report?"Tornado"===e.report.hazard?(t=tor_blurb.replace("$REPORTER",e.report.reporter),e.location.county&&(t=t.replace("$PLACE",`for ${e.location.county} county.`)),e.report.is_tor_emergency&&(t+=tor_emergency_blurb)):"Hail"===e.report.hazard&&e.report.magnitude&&e.report.magnitude>=2&&(t=sev_hail_blurb.replace("$MAG",e.report.magnitude).replace("$PLACE",e.location.county?`for ${e.location.county} county.`:"")):e.outlook&&"Day1"===e.outlook.swo_type?t=new_outlook_blurb.replace("$RISK",getRiskWords(e.outlook.max_risk)):e.md&&0===e.md.concerning.indexOf("New")?(probability=e.md.watch_issuance_probability?`with ${e.md.watch_issuance_probability}% watch chance`:"",t=new_md_blurb.replace("$NUMBER",e.md.id).replace("$PROBABILITY",probability)):"NwsTor"===e.event_type?t=tor_warning_blurb.replace("$PLACE",e.warning.issued_for).replace("$PDS",e.warning.is_pds?"PDS":""):e.watch&&"Issued"===e.watch.status&&(o=!0,t=new_watch_blurb.replace("$PDS",e.watch.is_pds?"PDS":"").replace("$WATCHTYPE",e.watch.watch_type).replace("$PLACE",e.watch.issued_for)),t&&(o&&queueAlert("eas"),queueAlert(t)),e)};function getRiskWords(e){switch(e){case"MRGL":return"there is a Marginal Risk of severe thunderstorms";case"SLGT":return"there is a Slight Risk of severe thunderstorms";case"ENH":return"there is an Enhanced Risk of severe thunderstorms";case"MDT":return"there is a Moderate Risk of severe thunderstorms";case"HIGH":return"there is a High Risk of severe thunderstorms";default:return""}}const processEvents=()=>{const e=get_current_location(),t=app.events.map(buildAlertForEvent),o=truncateEvents(t);app.events=o.map(t=>massageEvent(t,e)),app.displayEvents=app.events.filter(t=>filterEvent(t,e))},truncateEvents=e=>{const t=1e3*Date.now()-108e8;let o=null;for(let n=0;n<e.length;n++)if(e[n].ingest_ts<t){o=n;break}return null!==o?e.slice(0,o):e},get_importance=e=>{let t=!1;return"NwsSwo"===e.event_type?e.md&&0===e.md.concerning.indexOf("New")?t=!0:e.outlook&&"Day1"===e.outlook.swo_type&&(t=!0):"SnReport"===e.event_type||"NwsLsr"===e.event_type?("Tornado"!==e.report.hazard&&"WallCloud"!==e.report.hazard||(t=!0),"Hail"===e.report.hazard&&e.report.magnitude&&e.report.magnitude>2&&(t=!0)):"NwsTor"===e.event_type?t=!0:"NwsSel"===e.event_type&&e.watch&&"Issued"===e.watch.status&&(t=!0),t},get_time_ago=(e,t)=>{const o=e-t;return o<6e7?"<1m":o<36e8?`${Math.floor(o/6e7)}m`:o<864e8?`${Math.floor(o/36e8)}h`:"1d+"},pad_zero=e=>{if(!isNaN(e)){const t=parseInt(e);if(t<10&&t>-1)return`0${e}`}return e},save_config=()=>{try{localStorage.setItem(ls_config_key,JSON.stringify(app.config)),localStorage.setItem(ls_config_items_key,JSON.stringify(app.config_items))}catch(e){console.error(`Error saving config: ${e}`)}},load_config=()=>{try{const e=localStorage.getItem(ls_config_key),t=localStorage.getItem(ls_config_items_key);e&&(app.config=JSON.parse(e)),t&&(app.config_items=JSON.parse(t)),console.log("Loaded config.")}catch(e){console.error(`Error loading config: ${e}`)}},get_center_simple=e=>{let t=0,o=0;return e.forEach(e=>{t+=e.lat,o+=e.lon}),{lat:t/e.length,lon:o/e.length}},app=new Vue({el:"#app",data:{events:[],displayEvents:[],config_items:[{id:"gpsLocation",text:"Manual GPS Location",toggled:!1},{id:"hideAfds",text:"Hide AFDs",toggled:!1},{id:"chaseMode",text:"Chase Mode",toggled:!1},{id:"audioAlerts",text:"Audio Alerts",toggled:!0}],config:{manualLat:null,manualLon:null},clock:get_clock(),details_source:"",details_text:"",details_time:"",sidebar_active:!1},methods:{showEventDetails:function(e){app.events.forEach(e=>{e.derived.selected=!1}),e.derived.selected=!0,this.details_source=`Source: ${e.event_type}`,this.details_text=e.text,this.details_time=`Time: ${e.derived.parsed_dt}`},toggleConfig:function(e){const t=this.config_items.find(t=>t.id===e);t.toggled=!t.toggled},toggleSidebar:function(){this.sidebar_active=!this.sidebar_active,this.sidebar_active||(save_config(),processEvents())}}}),legalese="sware is not to be used while driving and shall not be used to guarantee one's safety.\n\nIt is alpha software - use at your own risk!";if(confirm(legalese)){load_config(),fetchUrl(`${api_base}/${last_ts}`),setInterval(()=>{fetchUrl(`${api_base}/${last_ts}`)},6e4)}const audioElement=document.createElement("audio"),synth=window.speechSynthesis,alert_config=app.config_items.find(e=>"audioAlerts"===e.id);let audioQueue=[],processing=!1;function processQueue(){processing=!0;const e=audioQueue[0],t=()=>{audioQueue.length<=1?(audioQueue=[],processing=!1):(audioQueue=audioQueue.slice(1),setTimeout(processQueue,2e3))};"eas"===e?(audioElement.src=`assets/${e}.mp3`,audioElement.onended=t,audioElement.onerror=t,audioElement.play()):(e.onend=t,synth.speak(e))}function queueAlert(e){if(synth&&alert_config.toggled&&e){if("eas"===e)audioQueue.push(e);else{const t=new SpeechSynthesisUtterance(e);audioQueue.push(t)}processing||processQueue()}}